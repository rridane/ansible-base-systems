---
- name: "Swap | Check current state"
  ansible.builtin.command: swapon --show --noheadings
  register: swap_show
  changed_when: false
  failed_when: false

- block:
    - name: "Swap | Disable now"
      ansible.builtin.command: swapoff -a
      become: true
      when: (swap_show.stdout | length) > 0

    - name: "Swap | Comment swap entries in fstab"
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^(?!#)(\S+\s+\S+\s+swap\s+\S+.*)$'
        replace: '# \1'
        backup: false
      become: true
  when: not swap_enabled

- block:
    - name: "Swap | Enable now"
      ansible.builtin.command: swapon -a
      become: true

    - name: "Swap | Uncomment swap entries in fstab"
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^#\s*(\S+\s+\S+\s+swap\s+\S+.*)$'
        replace: '\1'
        backup: false
      become: true
  when: swap_enabled
